<html>
<head>
	<title>Oil Production 1965-2011</title>

	<script src="js/jquery-1.10.2.min.map" charset="utf-8"></script>	
	<script src="js/jquery-1.10.2.min.js" charset="utf-8"></script>
	<script src="js/d3.v3.min.js" charset="utf-8"></script>


	<style>

	.link {
	  stroke: #000;
	}

	.node {
	  stroke: #000;
	}
	circle {
 		stroke: #000;
		fill-opacity: .3;
	}
	</style>


	<script type="text/javascript">
	
	var year = '2009';		// year to display
	var scaling = 1/15;		// scaling factor for bubbles
	var width = 4000,		// width and height of the svg to draw 
		height = 4000;
		
	var svg;	// the svg D3 draws to
	var pack;	// the d3 pack layout
	var regionsData = {}; // json data to be drawn by the pack layout
	
	// these will have .csv added to the end	
	// list of loaded files (removed when each is loaded)
	// could/should have built this dynamically
	var loadedFiles = [ {name: "americas", loaded:false}, 
						{name:"europeeurasia", loaded:false},
						{name:"middleeast", loaded:false},
						{name:"africa", loaded:false},
						{name:"asiapacific", loaded:false} ];
	
	//
	// mark file as loaded and return true if all files are loaded, or else false
	//
	function checkLoaded(filename)
	{
		var allLoaded = true;
		
		$.each( loadedFiles, function(i, fobj)
		{
			if (fobj.name === filename)
			{
				fobj.loaded = true;
				//console.log(fobj.name + " is loaded");
			}
			allLoaded = (allLoaded && fobj.loaded);
		});

/* DEBUG		
		if (allLoaded) 
		{
			console.log("all loaded!");
		}
*/		
		return allLoaded;
	}
	
	
	//
	// start the loading process
	//
	function startLoad()
	{
		$.each( loadedFiles, function(i, fobj)
		{
			fobj.loaded = false;
		});
	}
	
	
	window.addEventListener("load", function() {
		console.log("load");
		
		// build years select dropdown form
		var years = $('#years-dropdown');
		years.append($("<option selected>").attr('value','2009').text('2009'));
		var i=2008;
		while (i > 1964)
		{
			years.append($("<option>").attr('value',i).text(i));
			--i;
		}
		
		// bind refreshing data to this form changing
		years.change( function() 
		{
			$( "#years-dropdown option:selected" ).each(function() {
		      year = $( this ).text();
    		});
		
			refreshData();
		});
		
		startLoad();
		
		// load the data and build graph
		initData();
	
	}); // end onload
	
	
	//
	// add entry to regions data object if none exists
	//
	function addRegionEntry(name, val, regionsObj) 
	{
		return regionsObj[name] || (regionsObj[name] = {name: name, value: val});
	}

	
	
	//
	// load the data and create the svg and draw initial graph
	//
	function initData()
	{
		console.log ("initData()");
		
		d3.select("svg")
	   .remove();
		   
		svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);
		
		pack = d3.layout.pack()
//				.sort(d3.descending)
			.size([width,height]);
		
		regionsData = { name: "root", children: [] };
		
		$.each( loadedFiles, function (index, fn) 
		{
			if (!fn.loaded) loadRegion (fn.name, regionsData.children);
		});
		
	}
	
	
	//
	// load a region from a csv and add it to an array and
	// run callback when done
	//
	function loadRegion( filename, regionsArray )
	{
		d3.csv("data/" + filename + ".csv", function(rows) 
		{	
			var regionData = { name: filename, children: [] };
			var regions = {};
			
			rows.sort(function(a,b) {return a[year]-b[year];});
					
			rows.forEach(function( row )
			{	
// DEBUG
//				console.log(row);
// fields: 
// Region,total,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010
//				$('#output').append( '<p>' + row.Region + ' :: ' + row[year] + '</p>');

				var regionObj = addRegionEntry(row.Region, row[year], regions);
			});
		
		
			d3.values(regions).forEach( function (region) {
				var v = parseInt(region.value);
				if (!isNaN(v))
					regionData.children.push( { name: region.name, value: v*scaling } );
			});
			
			//console.log( nodeData );
			console.log( regionData );
			regionsArray.push( regionData );

			console.log( "done loading: " + filename );

			// check if all are loaded, if so refresh the data
			if ( checkLoaded( filename)) refreshData( regionsData );
		});	
	
	}

	
	//
	// populate the pack layour using the given nodeData
	//
	function refreshData( nodeData )
	{
		console.log ("refreshData()");
		console.log ( nodeData );
		// Extract the array of nodes from the map by name.
		// Create the node circles.
		  var node = svg.data([nodeData]).selectAll(".node")
			  .data(pack.nodes);

		var posX = 0;
		var posY = 0;
	
		var elemEnter = node.enter();
		var calcX = function(d) { 
				var x = parseInt(d.value)*scaling || 1;
				posX += x;
				return (posX-x/2);
			};
	
		elemEnter			
		  .append("circle")
		  .attr("class", "node")
			.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
		  .attr("fill", function (d) { return d3.hsl(d.r/6, 1, 0.8) })
		.attr("r", 0)
		  .transition().duration(1200).delay(100)
		  .attr("r", function(d) { return d.r } );
	
		posX = 0;
		posY = 0;
		elemEnter
			.append("text")
			.text( function(d) { return d.name + ': ' + parseInt(d.value)})
			.attr("transform", function(d) { return "translate(" + (d.x - d.r/2) + "," + d.y + ")"; })
			.attr("font-family", "sans-serif")
			.attr("font-size", "14px")
			.style('opacity', 0)
			.attr("fill", "black")
			.transition().duration(1200).delay(100)			  
			.style('opacity', 1);	
		
	}// end refreshdata
	
	</script>

</head>
<body>
<div id="output">
<form>
<select id="years-dropdown">
</select>
</form>

</div>
</body>
</html>